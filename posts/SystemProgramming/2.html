<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
<!-------------------------------------------------------------title goes here  --------------------------------------------------------------------->
<!-------------------------------------------------------------title goes here  --------------------------------------------------------------------->
    <title>[SP]第二週</title>
<!-------------------------------------------------------------title goes here  --------------------------------------------------------------------->
<!-------------------------------------------------------------title goes here  --------------------------------------------------------------------->


    <!-- Bootstrap Core CSS -->
<!---------------------------------------------------------Change CSS relative position here  -------------------------------------------------------->    
<!---------------------------------------------------------Change CSS relative position here  -------------------------------------------------------->
    <link href="../../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Theme CSS -->
    <link href="../../css/clean-blog.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="../../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
<!---------------------------------------------------------Change CSS relative position here  -------------------------------------------------------->
<!---------------------------------------------------------Change CSS relative position here  -------------------------------------------------------->
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- 下面這行加入Math Jax 的 LaTex CDN -->
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    Menu <i class="fa fa-bars"></i>
                </button>
<!---------------------------------------------------------Change html relative position here  ------------------------------------------------------->        
<!---------------------------------------------------------Change html relative position here  ------------------------------------------------------->        
                <a class="navbar-brand" href="../../index.html">Noob Notes</a>
<!---------------------------------------------------------Change html relative position here  ------------------------------------------------------->        
<!---------------------------------------------------------Change html relative position here  ------------------------------------------------------->        
            </div>



            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
<!---------------------------------------------------------Change html relative position here  ------------------------------------------------------->
<!---------------------------------------------------------Change html relative position here  ------------------------------------------------------->
                    <li>
                        <a href="../../index.html">Latest</a>
                    </li>
                    <li>
                        <a href="../../about.html">About</a>
                    </li>
                    <li>
                        <a href="../../category.html">Category</a>
                    </li>
                    <!--
                    <li>
                        <a href="../contact.html">Contact</a>
                    </li>
                    -->
<!---------------------------------------------------------Change html relative position here  ------------------------------------------------------->
<!---------------------------------------------------------Change html relative position here  ------------------------------------------------------->
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
<!---------------------------------------------------------Change URL relative position here  ------------------------------------------------------->   
<!---------------------------------------------------------Change URL relative position here  ------------------------------------------------------->   
    <header class="intro-header" style="background-image: url('../../img/post-bg.jpg')">
<!---------------------------------------------------------Change URL relative position here  ------------------------------------------------------->   
<!---------------------------------------------------------Change URL relative position here  ------------------------------------------------------->   
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
<!-------------------------------------------------------------------header goes here  --------------------------------------------------------------->
<!-------------------------------------------------------------------header goes here  --------------------------------------------------------------->
                        <h1>[SP]第二週筆記</h1>
                        <h2 class="subheading">我也不知道要上什麼</h2>
                        <span class="meta">Posted by <a>Fernando Lin</a> on 09, 21, 2016</span>
<!-------------------------------------------------------------------header goes here  --------------------------------------------------------------->
<!-------------------------------------------------------------------header goes here  --------------------------------------------------------------->
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Post Content -->
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!--
                    <h2 class="section-heading">用這個來寫標題</h2>
                    <p>用這個寫內文</p>
                    <p>\(...inline latex use this tag...\)</p>
                    <p>$$...Out-of-line latex use this tag...$$</p>
                    <blockquote>用這個寫註解</blockquote>
                -->                        
<!-------------------------------------------------------------------content goes here  --------------------------------------------------------------->
                     
                  <p>今天要學到「電腦怎麼找到檔案」「開一個檔案時會發生什麼事」「打開檔案之後作業系統要怎麼讀寫？」等等議題。</p>
                    <h2 class="section-heading">File System</h2>
                    <p>現在的File System其實是1970年開發出來的檔案系統，不過現在檔案越來越多，所以有點不敷使用中。</p>
                    <img class = "img-responsive" src="1_res/1_open_a_file.png" alt="">
                    <p>Storage Device上會切出很多「data block」(比如說4K)，。同一個檔案的data blocks不一定會放在連續的位置。</p>
                    <p>基本上所有table都是一個fd ＋ 檔案名 + 指向去哪裡找資料的pointer。</p>
                    <p>每一個fd會對到一個「可以讀或寫的東西」，至於這些東西是不是同一個<b>隨便</b>！他一點也不關心。這是作業系統才關心的事。
                        舉例來說，假設某天以要同時讀與寫一個檔案，所以就開了兩次檔的話，在Tables of Open Files裡面，裡面就會有兩條fd，一條說「這是一個用來寫的東西」，另外一條說「這是用來讀的東西」。至於兩個一不一樣他並不關心。
                        但對作業系統來說，system open table中這兩條fd會對應到同一個id。</p>
                    <p>I-core會把邏輯位置轉成物理位置，然後把參數丟給磁碟機叫他讀出相對應的檔案。</p>
                    <p></p>
                    <p>開完檔案之後，要做讀寫。這時候找檔案的方式就直接用fd來找了，然後一路查下去。</p>
                    <p>為什麼要多一個System Open File Table ？ 因為可以有「捷徑」，同一個檔案可以有不同通往他的捷徑。對於system Open File Table中，每個這樣的檔案只會有一個id。</p>
                    <p>開檔之後可以做什麼：</p>
                    <ul>
                        <li>open, close, read, write, lseek, dub</li>
                        <li>fcntl(前面的東西都是用這個東西來實作的，可以說是最基本的。), ioctl</li>
                        <li>chmod, chown：改權限的東西(這個應該滿常用的)</li>
                        <li>mkdir, cd：應該是滿常用的吧～</li>
                    </ul>
                    <h2 class="section-heading">File Descripter</h2>
                    <p>每開一個檔案就會給他一個編號。是一個無號整數，大小從0到OPEN_MAX。每一個Process可以開的檔案有最大上限，作業系統能開的檔案數目也養上限。</p>
                    <p>每個Process一開始跑的時候，作業系統會預設開好3個檔案：</p>
                    <ul>
                        <li>0：STDIN_FILENO(在Terminal 打東西)</li>
                        <li>1：STDOUT_FILENO(在Terminal 顯示東西)</li>
                        <li>2：STDOUT_FILENO</li>
                        <li>3號以後都是給其他process用了</li>
                    </ul>
                    <p>在Linux 跟UNIX-Like系統中，所有讀寫裝置都會被當成是檔案，比如說鍵盤就是會一直自動長大的檔案，程式可以讀它。Terminal螢幕就是一個程式可以一直在上面寫東西的檔案。</p>
                    <p>這3個fd在System Open Table中的同一個東西。剛剛也說過，不同fd可以對應到同一個檔案嘛。</p>
                    <p>之後如果有程式開檔，就會一直往下編。編號方法以及要怎麼回收已經關掉的檔案會一作業系統有所不同。舉例來說，可以每次都從下面往下找</p>
                    <h2 class="section-heading">Open()</h2>
                    <p>int open(const char * pathname, int oflag, .../*mode_t mode*/)</p>
                    <p>成功的話會回傳檔案的fd，失敗會回傳-1</p>
                    <p>首先是檔案路徑有上限，不能超過PATH_MAX。檔案名也不能超過NAME_MAX</p>
                    <p>oflag表示檔案讀寫的模式。在開檔的時後就要決定好了。</p>
                    <p>O_RDONLY, O_WRONLY, O_RDWD：檔案讀寫權限。因為每個使用者權限不同，所以不能無腦的通通用O_RDWD。只能3選一。</p>
                    <p>O_APPEND, O_TRUNC：就跟C讀寫檔案的那些參數一樣。</p>
                    <p>O_EXCL：如果已經有相同檔案名存在的話，那開啟會失敗(不會蓋過去也不會在後面加上)</p>
                    <p>O_NONBLOCK：函數做完之後才會回傳，所以呼叫他的函數要等它做完，才會繼續做階下來的事，這就是「Blocking」。Non-Blcking就是可以不等函數回傳，先去做自己的事。
                        Non-Blocking在這裡很重要，因為I/O通常慢，所以如果一直等I/O速度會很慢。
                    </p>
                    <p>O_DSYNC, O_RSYNC, O_SYNC：在寫檔案的時候要不要同步更新到storage device上面。打開的話會比較安全，因為可以立刻存起來，但是速度會很慢，因為Disk I/O很慢。</p>
                    <p>要使用的話就把他們OR起來比如：</p>
                    <p>open(filename, O_WRONLY | O_CREAT | O_TRUNC, mode)：開一個檔，寫他。如果沒有舊創一個新的，如果已經有的話就把東西全部蓋掉。</p>
                    <p>mode那一個參數跟chown與chmod那個是一樣的。</p>
                    <p>為什麼要那麼多權限？最明顯的理由是為了安全，不要動到不該動到的東西。在多個Process可能共用個檔案時這件事很重要。跟這個牽扯到的哢外一個議題是file lock。
                        另外一個理由是效能，這個有點像是硬體中cache有沒有被污染的機制。如果cache被污染，就要考慮要不要寫回硬碟。但是如果知道大家都是Read Only，那根本不用考慮這件事。</p>
                    <p>開完之後就可以開始讀寫她了～</p>
                    <h2 class="section-heading">read() & write()</h2>
                    <p>read()</p>
                    <p>(自已去查man page)</p>
                    <p>第一個變數是檔案fd，第二個是要寫進去的資料，第3個是要寫多少bytes。回傳它實際上寫了多少個bytes，正常來說應該要一樣，所以不一樣的話就知道出了一些事(比如說碰到EOF)</p>
                    <p>還記得fseek()用到的那個檔案位置嗎?read()跟write()會自動更動讀寫位置offset。順帶一提，offset是指「距離檔案頭的位置」，所以通常是正的，但是如果他是負的就表示<b>你在動kernel memory</b></p>
                    <p>在檔案讀寫發生在同一個位置時(比如說Terminal)，那讀寫的offset是一樣的。但是如果不一樣，那通常會open()兩次。</p>
                    <p>write()</p>
                    <p>去查mam page</p>
                    <p>大致上一樣，不過要注意如果開檔時是用O_APPEND，那在寫入時就不會移動offset(其實還是會，但是他會寫完時把offset移回一開始的位置)。</p>
                    <h2 class="section-heading">存取Storage資料的流程</h2>
                    <p>啊 就塞個buffer，先改buffer，必要時在存給Storage就好了。跟Cache原理一樣。</p>
                    <p>Kernel會定期檢查buffer，如果buffer有被改過，就會寫回Disk; 如果buffer滿了，那也會立刻把東西塞回disk;關檔時也會把buffer清到Disk。</p>
                    <p>O_DSYNKC會把Kernel Buffer跟Disk的資料一起改動，但檔案File imformation 不會立刻更新</p>
                    <p>O_OSYNKC會把Kernel Buffer跟Disk與File imformation一起更新。跟O_DSYNC差在如果程式寫到一半crush，那O_DSYNC會讓File Imformation與實際內容有出入。</p>
                    <p>雖然不Sync會比較快，但對concurrency資料的一致性會有影響，因為東西可能會存在kernel buffer還沒寫到disk理，另外一個process就要讀的話，他就會讀到就的資料。</p>
                    <p>那能不能讓要用資料的人自己去sync？可以！O_RSYNC有這個功能。O_RSYNC是「有人要讀的時候，再把kernal buffer更新到disk上」。</p>
                    <p>這些東西都可以混用，比如說可以O_RSYNC & O_OSYNC。然後OSX會有不一樣的巨集。</p>
                    <p>Linux不知道哪一個版本之後就把O_DSYNC跟O_OSYNC合併了，因為File Imformation通常遠小於Data內容。</p>
                    <blockquote>
                        <p>師：「現在中午了，如果你請你同學幫你買便當，他拿了錢就跑，你也不知道是怎麼一回事，這就是blocking; 40分鐘之後你等他拿便當回來了，這就是synchronized。
                        他跟你說「我買完打電話給你」，這就是non-blocking。那有Asynchronized的例子嗎？」</p>
                        <p>(安靜)</p>
                        <p>生：「...有人幫忙買好了？」</p>
                        <p>師：「對。樓下那台餐車就是Asynchrnized，那就是個buffer。如果你買不到的話(搖指)那裡118巷就是你的storage device。」</p>    
                    </blockquote>
                    
                    


                    
<!-------------------------------------------------------------------content goes here  --------------------------------------------------------------->
                </div>
            </div>
        </div>
    </article>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a>
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://www.facebook.com/profile.php?id=100001416766501">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://github.com/0xff07">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
                    <p class="copyright text-muted">Copyright &copy; Yo-Jung Lin 2016</p>
                </div>
            </div>
        </div>
    </footer>






<!---------------------------------------------------------Change html relative position here  ------------------------------------------------------->
<!---------------------------------------------------------Change html relative position here  ------------------------------------------------------->
    <!-- jQuery -->
    <script src="../../vendor/jquery/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="../../vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- Contact Form JavaScript -->
    <script src="../../js/jqBootstrapValidation.js"></script>
    <script src="../../js/contact_me.js"></script>

    <!-- Theme JavaScript -->
    <script src="../../js/clean-blog.min.js"></script>
<!---------------------------------------------------------Change html relative position here  ------------------------------------------------------->
<!---------------------------------------------------------Change html relative position here  ------------------------------------------------------->
   




</body>

</html>
